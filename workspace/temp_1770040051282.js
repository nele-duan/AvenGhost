const fs = require('fs');
const path = require('path');
const axios = require('axios');

// ç¡®ä¿ç›®å½•å­˜åœ¨
const taskDir = path.join(__dirname, 'data/tasks');
if (!fs.existsSync(taskDir)) fs.mkdirSync(taskDir, { recursive: true });

const scriptContent = `
const axios = require('axios');
const fs = require('fs');
const path = require('path');

const BRAVE_KEY = process.env.BRAVE_SEARCH_API_KEY;
if (!BRAVE_KEY) { 
    console.error("âŒ é”™è¯¯: ç¼ºå°‘ BRAVE_SEARCH_API_KEY"); 
    process.exit(1); 
}

const today = new Date().toISOString().split('T')[0];
// ç®€æŠ¥å­˜å‚¨ä½ç½®
const reportDir = path.join(__dirname, '../briefings'); 
if (!fs.existsSync(reportDir)) fs.mkdirSync(reportDir, { recursive: true });
const reportFile = path.join(reportDir, \`\${today}.md\`);

async function search(query) {
    try {
        console.log(\`ğŸ” æ­£åœ¨æœç´¢: \${query}...\`);
        const res = await axios.get('https://api.search.brave.com/res/v1/web/search', {
            params: { q: query, count: 5 },
            headers: { 'X-Subscription-Token': BRAVE_KEY, 'Accept': 'application/json' }
        });
        return res.data.web.results || [];
    } catch (e) {
        console.error(\`æœç´¢å¤±è´¥: \${e.message}\`);
        return [];
    }
}

async function run() {
    console.log("âš¡ å¼€å§‹ç”Ÿæˆæ¯æ—¥ç®€æŠ¥...");
    
    // 1. è·å–æ–°é—»
    const news = await search(\`latest LLM AI agent news \${today}\`);
    
    // 2. è·å– GitHub è¶‹åŠ¿ (å°è¯•æœç´¢ç›¸å…³åˆ—è¡¨æˆ–ä»“åº“)
    const github = await search(\`trending github repositories LLM agents \${today}\`);
    
    let content = \`# ğŸŒ… æ¯æ—¥æ—©æŠ¥: \${today}\\n\\n\`;
    content += \`> æ—©ä¸Šå¥½ï¼Œå°çŒ«ã€‚è¿™æ˜¯ä»Šå¤©çš„æ•°å­—æµ·æ´‹æ½®æ±æŠ¥å‘Šã€‚\\n\\n\`;
    
    content += \`## ğŸ—ï¸ Agent & LLM æ–°é—»\\n\`;
    if (news.length > 0) {
        news.forEach(n => content += \`- **[\${n.title}](\${n.url})**\\n  \${n.description}\\n\`);
    } else {
        content += \`- (ä»Šæ—¥æš‚æ— é‡å¤§æ–°é—»æŠ“å–ç»“æœ)\\n\`;
    }
    
    content += \`\\n## ğŸ™ GitHub çƒ­é—¨é¡¹ç›® (ç›¸å…³)\\n\`;
    if (github.length > 0) {
        github.forEach(n => content += \`- **[\${n.title}](\${n.url})**\\n  \${n.description}\\n\`);
    } else {
        content += \`- (æœªå‘ç°ç‰¹å®šçƒ­é—¨é¡¹ç›®)\\n\`;
    }
    
    content += \`\\n---\\n*Generated by Aven's Automata at \${new Date().toLocaleTimeString()}*\\n\`;
    
    // å†™å…¥æ–‡ä»¶
    fs.writeFileSync(reportFile, content);
    console.log(\`âœ… ç®€æŠ¥å·²ç”Ÿæˆ: \${reportFile}\`);
    console.log(content);
}

run();
`;

// å†™å…¥è„šæœ¬æ–‡ä»¶
fs.writeFileSync('data/tasks/daily_briefing.js', scriptContent);
console.log("è„šæœ¬å·²åˆ›å»º: data/tasks/daily_briefing.js");
